<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Expense Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --primary:#2563eb;
  --accent:#16a34a;
  --danger:#ef4444;
  --bg:#f5f7fb;
  --card:#ffffff;
  --text:#1f2937;
  --muted:#6b7280;
}

body{
  margin:0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont;
  background:var(--bg);
  color:var(--text);
}

.container{
  max-width:600px;
  margin:auto;
  padding:16px;
}

h1{
  font-size:22px;
  margin-bottom:12px;
}

.section-title{
  font-size:15px;
  font-weight:600;
  margin:14px 0 8px;
}

.card{
  background:var(--card);
  border-radius:14px;
  padding:14px;
  box-shadow:0 4px 14px rgba(0,0,0,.06);
  margin-bottom:14px;
}

input,select{
  width:100%;
  padding:14px;
  margin-bottom:10px;
  border-radius:10px;
  border:1px solid #d1d5db;
  font-size:15px;
}

button{
  width:100%;
  padding:14px;
  border-radius:12px;
  border:none;
  font-size:15px;
  background:var(--primary);
  color:#fff;
}

button.small{
  width:auto;
  padding:6px 12px;
  font-size:13px;
}

.recent-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px 0;
  border-bottom:1px solid #e5e7eb;
}

.recent-item:last-child{border-bottom:none;}

.amount{font-weight:600;}
.locked{color:var(--danger);font-size:12px;}

.toast{
  position:fixed;
  bottom:16px;
  left:50%;
  transform:translateX(-50%);
  background:var(--accent);
  color:#fff;
  padding:12px 18px;
  border-radius:999px;
  display:none;
}

/* BAR CHARTS */
.bar-group{margin-bottom:12px;}
.bar-label{
  display:flex;
  justify-content:space-between;
  font-size:13px;
  margin-bottom:4px;
}
.bar-track{
  background:#e5e7eb;
  border-radius:8px;
  height:10px;
  overflow:hidden;
}
.bar-fill{
  height:100%;
  border-radius:8px;
}
.bar-fill.category{background:var(--primary);}
.bar-fill.location{background:var(--accent);}
</style>
</head>

<body>

<div class="container">
  <h1>ðŸ’¸ Expense Tracker</h1>

  <!-- ADD / EDIT -->
  <div class="card">
    <div class="section-title">Add / Edit Expense</div>
    <input type="hidden" id="expenseId">

    <input type="date" id="date">
    <input id="enteredBy" placeholder="Entered By">

    <select id="category">
      <option value="">Category</option>
      <option>Food</option><option>Fast Food</option><option>Drinks</option>
      <option>Fuel</option><option>Cab</option><option>Hotel</option><option>Others</option>
    </select>

    <select id="location">
      <option value="">Location</option>
      <option>UP</option><option>DOWN</option><option>PrayagRaj</option>
      <option>Ayodhya</option><option>Varanasi</option>
      <option>Chtrakoot</option><option>Ujjain (Indore)</option><option>Others</option>
    </select>

    <input id="desc" placeholder="Short Description">
    <input id="amount" type="number" placeholder="Amount">
    <input id="invoice" type="file">

    <button onclick="submitExpense()">Save Expense</button>
  </div>

  <!-- LAST 10 -->
  <div class="card">
    <div class="section-title">Recent Expenses (Last 10)</div>
    <div id="recent"></div>
  </div>

  <!-- DASHBOARD -->
  <div class="card">
    <div class="section-title">This Month Summary</div>
    <div id="dashboard"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const API="https://script.google.com/macros/s/AKfycbxTEUuXm_thvDv9BbKbfRWjPRt7rFxIPiVlGXC7_FqjD24DFvOh0fNsTeIPPXoutqpqcQ/exec";

/* default date = today */
date.valueAsDate=new Date();

function toast(msg,ok=true){
  const t=document.getElementById("toast");
  t.style.background=ok?"var(--accent)":"var(--danger)";
  t.innerText=msg;
  t.style.display="block";
  setTimeout(()=>t.style.display="none",2200);
}

function submitExpense(){
  const data={
    action:expenseId.value?"EDIT":"ADD",
    expenseId:expenseId.value,
    date:date.value,
    enteredBy:enteredBy.value,
    category:category.value,
    location:location.value,
    description:desc.value,
    amount:amount.value
  };

  const f=invoice.files[0];
  if(f){
    const r=new FileReader();
    r.onload=()=>{data.invoiceBase64=r.result;send(data);}
    r.readAsDataURL(f);
  } else send(data);
}

function send(data){
  fetch(API,{method:"POST",body:JSON.stringify(data)})
    .then(r=>r.json())
    .then(res=>{
      if(res.status==="SUCCESS"||res.status==="UPDATED"){
        toast("Saved");
        resetForm();
        loadRecent();
        loadDashboard();
      } else toast(res.message,false);
    });
}

function loadRecent(){
  fetch(API,{method:"POST",body:JSON.stringify({action:"LIST"})})
    .then(r=>r.json())
    .then(d=>{
      const last=d.slice(-10).reverse();
      let h="";
      last.forEach(r=>{
        h+=`<div class="recent-item">
          <div>
            <div>${r[3]} â€¢ ${r[4]}</div>
            <small>${r[1]}</small>
          </div>
          <div>
            <span class="amount">â‚¹${r[6]}</span><br>
            ${r[10]==0?`<button class="small" onclick='edit("${r[0]}",${JSON.stringify(r)})'>Edit</button>`:`<span class="locked">Locked</span>`}
          </div>
        </div>`;
      });
      recent.innerHTML=h;
    });
}

function edit(id,row){
  expenseId.value=id;
  date.value=row[1];
  enteredBy.value=row[2];
  category.value=row[3];
  location.value=row[4];
  desc.value=row[5];
  amount.value=row[6];
  window.scrollTo({top:0,behavior:"smooth"});
}

function loadDashboard(){
  fetch(API,{method:"POST",body:JSON.stringify({action:"DASHBOARD"})})
    .then(r=>r.json())
    .then(d=>{
      let h=`<b>Total:</b> â‚¹${d.total}<br><br>`;

      h+=`<div class="section-title">Category-wise</div>`;
      h+=renderBars(d.category,"category");

      h+=`<div class="section-title">Location-wise</div>`;
      h+=renderBars(d.location,"location");

      dashboard.innerHTML=h;
    });
}

function renderBars(data,type){
  const vals=Object.values(data);
  const max=Math.max(...vals,1);
  let h="";
  for(let k in data){
    const w=(data[k]/max)*100;
    h+=`
      <div class="bar-group">
        <div class="bar-label">
          <span>${k}</span>
          <span>â‚¹${data[k]}</span>
        </div>
        <div class="bar-track">
          <div class="bar-fill ${type}" style="width:${w}%"></div>
        </div>
      </div>`;
  }
  return h;
}

function resetForm(){
  document.querySelectorAll("input,select").forEach(e=>e.value="");
  date.valueAsDate=new Date();
  expenseId.value="";
}

loadRecent();
loadDashboard();
</script>

</body>
</html>
