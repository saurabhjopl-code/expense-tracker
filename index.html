<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Expense Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:system-ui;background:#f5f7fb;margin:0}
.container{max-width:600px;margin:auto;padding:16px}
.card{background:#fff;padding:14px;border-radius:14px;margin-bottom:14px}
input,select,button{width:100%;padding:14px;margin-bottom:10px;border-radius:10px}
button{background:#2563eb;color:#fff;border:none}
.small{width:auto;padding:6px 10px}
.bar{background:#e5e7eb;border-radius:6px;height:10px}
.fill{height:100%;border-radius:6px}
.cat{background:#2563eb}
.loc{background:#16a34a}
</style>
</head>

<body>
<div class="container">
<h2>ðŸ’¸ Expense Tracker</h2>

<div class="card">
<input type="hidden" id="expenseId">
<input type="date" id="date">
<input id="enteredBy" placeholder="Entered By">
<select id="category"><option>Food</option><option>Fuel</option><option>Hotel</option></select>
<select id="location"><option>UP</option><option>Varanasi</option><option>Others</option></select>
<input id="desc" placeholder="Description">
<input id="amount" type="number">
<input id="invoice" type="file">
<button onclick="save()">Save</button>
</div>

<div class="card">
<b>Last 10 Expenses</b>
<div id="recent"></div>
</div>

<div class="card">
<b>This Month Summary</b>
<div id="dashboard"></div>
</div>

<div class="card">
<b>Download PDF</b>
<input type="date" id="from">
<input type="date" id="to">
<button onclick="downloadPDF()">Download PDF</button>
</div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbxTEUuXm_thvDv9BbKbfRWjPRt7rFxIPiVlGXC7_FqjD24DFvOh0fNsTeIPPXoutqpqcQ/exec";
date.valueAsDate=new Date();

function save(){
  const d={action:expenseId.value?"EDIT":"ADD",
    expenseId:expenseId.value,
    date:date.value,enteredBy:enteredBy.value,
    category:category.value,location:location.value,
    description:desc.value,amount:amount.value};
  const f=invoice.files[0];
  if(f){const r=new FileReader();r.onload=()=>{d.invoiceBase64=r.result;send(d)};r.readAsDataURL(f)}
  else send(d);
}

function send(d){
  fetch(API,{method:"POST",body:JSON.stringify(d)}).then(()=>{load();});
}

function load(){
  fetch(API,{method:"POST",body:JSON.stringify({action:"LIST"})})
  .then(r=>r.json()).then(d=>{
    recent.innerHTML=d.slice(-10).reverse().map(r=>`
      <div>${r[3]} â€¢ ${r[4]} â‚¹${r[6]}
      ${r[10]==0?`<button class="small" onclick='edit("${r[0]}",${JSON.stringify(r)})'>Edit</button>`:""}</div>`).join("");
  });

  fetch(API,{method:"POST",body:JSON.stringify({action:"DASHBOARD"})})
  .then(r=>r.json()).then(d=>{
    dashboard.innerHTML=bars(d.category,"cat")+bars(d.location,"loc");
  });
}

function bars(obj,cls){
  let m=Math.max(...Object.values(obj),1),h="";
  for(let k in obj){
    h+=`${k} â‚¹${obj[k]}<div class="bar"><div class="fill ${cls}" style="width:${(obj[k]/m)*100}%"></div></div>`;
  }
  return h;
}

function edit(id,r){
  expenseId.value=id;date.value=r[1];enteredBy.value=r[2];
  category.value=r[3];location.value=r[4];
  desc.value=r[5];amount.value=r[6];
}

function downloadPDF(){
  fetch(API,{method:"POST",body:JSON.stringify({
    action:"PDF",from:from.value,to:to.value
  })}).then(r=>r.text()).then(b=>{
    const a=document.createElement("a");
    a.href="data:application/pdf;base64,"+b;
    a.download="Expense_Report.pdf";a.click();
  });
}

load();
</script>
</body>
</html>
