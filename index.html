<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Magh Mela – Expense Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --brand:#E9731A;
  --brand-dark:#B45309;
  --bg:#FFF7ED;
  --card:#FFFFFF;
  --text:#1F2937;
}

body{
  margin:0;
  font-family:system-ui;
  background:var(--bg);
  color:var(--text);
}

.container{
  max-width:760px;
  margin:auto;
  padding:20px;
}

.header{
  text-align:center;
  padding:20px 10px;
  border-bottom:3px solid var(--brand);
  margin-bottom:20px;
}

.header img{ height:180px; }

.card{
  background:var(--card);
  border-radius:14px;
  padding:20px;
  margin-bottom:20px;
  box-shadow:0 6px 18px rgba(0,0,0,.08);
}

.section-title{
  font-weight:600;
  margin-bottom:12px;
  color:var(--brand-dark);
}

.form-grid{
  display:grid;
  grid-template-columns:1fr;
  gap:14px;
}

@media(min-width:640px){
  .form-grid{ grid-template-columns:1fr 1fr; }
}

.full{ grid-column:1/-1; }

input,select{
  width:100%;
  padding:14px;
  border-radius:10px;
  border:1px solid #d1d5db;
  font-size:15px;
}

button{
  width:100%;
  padding:14px;
  border-radius:12px;
  border:none;
  font-size:15px;
  background:var(--brand);
  color:#fff;
  cursor:pointer;
}

table{
  width:100%;
  border-collapse:collapse;
}

th,td{
  padding:10px;
  border-bottom:1px solid #e5e7eb;
}

th{
  background:#FFF1E6;
  color:#92400E;
}

.footer{
  margin-top:30px;
  padding:14px;
  text-align:center;
  background:var(--brand-dark);
  color:#fff;
  font-size:13px;
}
</style>
</head>

<body>

<div class="container">

  <!-- HEADER -->
  <div class="header">
    <img src="assets/magh mela logo.jpeg" alt="Magh Mela Logo">
  </div>

  <!-- FORM -->
  <div class="card">
    <div class="section-title">Add / Edit Expense</div>

    <input type="hidden" id="expenseId">

    <div class="form-grid">
      <input type="date" id="date">
      <input id="enteredBy" placeholder="Entered By">

      <select id="category">
        <option value="">Category</option>
        <option>Food</option><option>Fast Food</option><option>Drinks</option>
        <option>Fuel</option><option>Cab</option><option>Hotel</option><option>Others</option>
      </select>

      <select id="location">
        <option value="">Location</option>
        <option>UP</option><option>DOWN</option><option>PrayagRaj</option>
        <option>Ayodhya</option><option>Varanasi</option>
        <option>Chtrakoot</option><option>Ujjain (Indore)</option><option>Others</option>
      </select>

      <input id="desc" class="full" placeholder="Short Description">
      <input id="amount" type="number" placeholder="Amount">
      <input id="invoice" type="file" class="full">

      <div class="full">
        <button onclick="saveExpense()">Save Expense</button>
      </div>
    </div>
  </div>

  <!-- LAST 10 -->
  <div class="card">
    <div class="section-title">Last 10 Expenses</div>
    <table id="recentTbl"></table>
  </div>

  <!-- SUMMARY -->
  <div class="card">
    <div class="section-title">Summary (This Month)</div>
    <div id="summary"></div>
  </div>

  <!-- PDF -->
  <div class="card">
    <div class="section-title">Download PDF Report</div>
    <input type="date" id="from">
    <input type="date" id="to">
    <button onclick="downloadPDF()">Download PDF</button>
  </div>

</div>

<div class="footer">
  <strong>FOR INTERNAL USE ONLY</strong><br>
  © Saurabh Mondal. All rights reserved.
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbxTEUuXm_thvDv9BbKbfRWjPRt7rFxIPiVlGXC7_FqjD24DFvOh0fNsTeIPPXoutqpqcQ/exec";
date.valueAsDate=new Date();

/* SAVE */
function saveExpense(){
  const data={
    action:expenseId.value?"EDIT":"ADD",
    expenseId:expenseId.value,
    date:date.value,
    enteredBy:enteredBy.value,
    category:category.value,
    location:location.value,
    description:desc.value,
    amount:amount.value
  };

  const file=invoice.files[0];
  if(file){
    const r=new FileReader();
    r.onload=()=>{ data.invoiceBase64=r.result; send(data); };
    r.readAsDataURL(file);
  } else send(data);
}

function send(data){
  fetch(API,{method:"POST",body:JSON.stringify(data)})
    .then(r=>r.json())
    .then(()=>{
      resetForm();
      loadAll();
    });
}

/* LOAD LAST 10 + SUMMARY */
function loadAll(){
  // Last 10
  fetch(API,{method:"POST",body:JSON.stringify({action:"LIST"})})
    .then(r=>r.json())
    .then(rows=>{
      const last=rows.slice(-10).reverse();
      let h="<tr><th>Category</th><th>Location</th><th>Amount</th></tr>";
      last.forEach(r=>{
        h+=`<tr onclick='edit("${r[0]}",${JSON.stringify(r)})'>
          <td>${r[3]}</td><td>${r[4]}</td><td>₹${r[6]}</td></tr>`;
      });
      recentTbl.innerHTML=h;
    });

  // Summary
  fetch(API,{method:"POST",body:JSON.stringify({action:"SUMMARY"})})
    .then(r=>r.json())
    .then(d=>{
      summary.innerHTML =
        buildSummaryTable(d.category,"Category") +
        "<br>" +
        buildSummaryTable(d.location,"Location");
    });
}

function buildSummaryTable(obj,label){
  let h=`<table><tr><th>${label}</th><th>Amount</th></tr>`;
  Object.keys(obj).sort((a,b)=>obj[b]-obj[a]).forEach(k=>{
    h+=`<tr><td>${k}</td><td>₹${obj[k]}</td></tr>`;
  });
  return h+"</table>";
}

/* EDIT */
function edit(id,row){
  expenseId.value=id;
  date.value=row[1];
  enteredBy.value=row[2];
  category.value=row[3];
  location.value=row[4];
  desc.value=row[5];
  amount.value=row[6];
  window.scrollTo({top:0,behavior:"smooth"});
}

/* PDF */
function downloadPDF(){
  fetch(API,{
    method:"POST",
    body:JSON.stringify({action:"PDF",from:from.value,to:to.value})
  })
  .then(r=>r.text())
  .then(b=>{
    const a=document.createElement("a");
    a.href="data:application/pdf;base64,"+b;
    a.download="Expense_Report.pdf";
    a.click();
  });
}

function resetForm(){
  document.querySelectorAll("input,select").forEach(e=>e.value="");
  date.valueAsDate=new Date();
  expenseId.value="";
}

loadAll();
</script>

</body>
</html>
