<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Magh Mela – Expense Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --brand:#E9731A;
  --brand-dark:#B45309;
  --bg:#FFF7ED;
  --card:#FFFFFF;
  --border:#E5E7EB;
  --text:#1F2937;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:system-ui;
  background:var(--bg);
  color:var(--text);
}

.app{
  max-width:760px;
  margin:auto;
  padding:16px;
}

.header{
  text-align:center;
  padding:20px 0;
  border-bottom:3px solid var(--brand);
  margin-bottom:20px;
}

.header img{ height:175px; }

.app-title{
  margin-top:8px;
  font-size:18px;
  font-weight:600;
  color:var(--brand-dark);
}

.card{
  background:var(--card);
  border-radius:14px;
  padding:18px;
  margin-bottom:20px;
  box-shadow:0 6px 16px rgba(0,0,0,.08);
}

.section-title{
  font-weight:600;
  margin-bottom:14px;
  color:var(--brand-dark);
}

.grid{
  display:grid;
  grid-template-columns:1fr;
  gap:14px;
}

@media(min-width:640px){
  .grid{ grid-template-columns:1fr 1fr; }
}

.full-row{ grid-column:1/-1; }

input,select{
  width:100%;
  padding:14px;
  border-radius:10px;
  border:1px solid var(--border);
  font-size:15px;
}

button{
  width:100%;
  padding:14px;
  border-radius:12px;
  border:none;
  font-size:15px;
  background:var(--brand);
  color:#fff;
}

table{
  width:100%;
  border-collapse:collapse;
}

th,td{
  padding:12px;
  border-bottom:1px solid var(--border);
}

th{
  background:#FFF1E6;
  color:#92400E;
}

.footer{
  margin-top:30px;
  padding:14px;
  text-align:center;
  background:var(--brand-dark);
  color:#fff;
  font-size:13px;
}
</style>
</head>

<body>

<div class="app">

  <div class="header">
    <img src="assets/magh mela logo.jpeg" alt="Magh Mela Logo">
    <div class="app-title">Magh Mela – Expense Tracker</div>
  </div>

  <div class="card">
    <div class="section-title">Add / Edit Expense</div>

    <input type="hidden" id="expenseId">

    <div class="grid">
      <input type="date" id="date">
      <input id="enteredBy" placeholder="Entered By">

      <select id="category">
        <option value="">Category</option>
        <option>Food</option><option>Fast Food</option><option>Drinks</option>
        <option>Fuel</option><option>Cab</option><option>Hotel</option><option>Others</option>
      </select>

      <select id="location">
        <option value="">Location</option>
        <option>UP</option><option>DOWN</option><option>PrayagRaj</option>
        <option>Ayodhya</option><option>Varanasi</option>
        <option>Chtrakoot</option><option>Ujjain (Indore)</option><option>Others</option>
      </select>

      <input id="desc" class="full-row" placeholder="Short Description">
      <input id="amount" type="number" placeholder="Amount">
      <input id="invoice" type="file" class="full-row">

      <div class="full-row">
        <button onclick="saveExpense()">Save Expense</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="section-title">Last 10 Expenses</div>
    <table id="recentTbl"></table>
  </div>

  <div class="card">
    <div class="section-title">Summary (This Month)</div>
    <div id="summary"></div>
  </div>

  <div class="card">
    <div class="section-title">Download PDF Report</div>
    <div class="grid">
      <input type="date" id="from">
      <input type="date" id="to">
      <div class="full-row">
        <button onclick="downloadPDF()">Download PDF</button>
      </div>
    </div>
  </div>

</div>

<div class="footer">
  <strong>FOR INTERNAL USE ONLY</strong><br>
  © Saurabh Mondal. All rights reserved.
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbxTEUuXm_thvDv9BbKbfRWjPRt7rFxIPiVlGXC7_FqjD24DFvOh0fNsTeIPPXoutqpqcQ/exec";
document.getElementById("date").valueAsDate = new Date();

/* SAVE */
function saveExpense(){
  const data={
    action: expenseId.value ? "EDIT" : "ADD",
    expenseId: expenseId.value,
    date: date.value,
    enteredBy: enteredBy.value,
    category: category.value,
    location: location.value,
    description: desc.value,
    amount: amount.value
  };

  const f=invoice.files[0];
  if(f){
    const r=new FileReader();
    r.onload=()=>{ data.invoiceBase64=r.result; send(data); };
    r.readAsDataURL(f);
  } else send(data);
}

function send(data){
  fetch(API,{method:"POST",body:JSON.stringify(data)})
    .then(r=>r.json())
    .then(()=>{ resetForm(); loadAll(); });
}

/* LOAD */
function loadAll(){
  fetch(API,{method:"POST",body:JSON.stringify({action:"LIST"})})
    .then(r=>r.json())
    .then(rows=>{
      const last=rows.slice(-10).reverse();
      let h="<tr><th>Category</th><th>Location</th><th>Amount</th></tr>";
      last.forEach(r=>{
        h+=`<tr onclick='editExpense("${r[0]}",${JSON.stringify(r)})'>
          <td>${r[3]}</td><td>${r[4]}</td><td>₹${r[6]}</td></tr>`;
      });
      recentTbl.innerHTML=h;
    });

  fetch(API,{method:"POST",body:JSON.stringify({action:"SUMMARY"})})
    .then(r=>r.json())
    .then(d=>{
      summary.innerHTML =
        buildTable(d.category,"Category") +
        "<br>" +
        buildTable(d.location,"Location");
    });
}

function buildTable(obj,label){
  let h=`<table><tr><th>${label}</th><th>Amount</th></tr>`;
  Object.keys(obj).sort((a,b)=>obj[b]-obj[a]).forEach(k=>{
    h+=`<tr><td>${k}</td><td>₹${obj[k]}</td></tr>`;
  });
  return h+"</table>";
}

/* EDIT */
function editExpense(id,r){
  expenseId.value=id;
  date.value=r[1];
  enteredBy.value=r[2];
  category.value=r[3];
  location.value=r[4];
  desc.value=r[5];
  amount.value=r[6];
  window.scrollTo({top:0,behavior:"smooth"});
}

/* PDF */
function downloadPDF(){
  fetch(API,{
    method:"POST",
    body:JSON.stringify({action:"PDF",from:from.value,to:to.value})
  })
  .then(r=>r.text())
  .then(b=>{
    const a=document.createElement("a");
    a.href="data:application/pdf;base64,"+b;
    a.download="Magh_Mela_Expense_Report.pdf";
    a.click();
  });
}

function resetForm(){
  document.querySelectorAll("input,select").forEach(e=>e.value="");
  date.valueAsDate=new Date();
  expenseId.value="";
}

loadAll();
</script>

</body>
</html>
